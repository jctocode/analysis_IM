pipe_modules = []
pipe_processes = 1

from foreground_clean import pair_set
from quadratic_products import pwrspec_combinations

do_cleaning = False
do_power = True

#-----------------------------------------------------------------------------
# use the base map parameters above to make a few map cleaning cases
#-----------------------------------------------------------------------------
# Special parameters that rarely need to get used
# no_weights: do not weight before finding nu-nu' covariance (False by default)
# SVD_root: use the SVD from another cleaning run on this run (None by default)
# regenerate_noise_inv: do not use memoize to save previous diag(N^-1) calc
# TODO
# add support for handing simulation index as env. var -> tack_on
# add timing to cleaning function
# move old scripts to history

nfreq = 40
cutlist = []
freq_list = tuple([ind for ind in range(nfreq) if ind not in cutlist])
mode_list = range(0, 50, 5)
common_res_convolution = False
sub_weighted_mean = True

simfile = '/mnt/raid-project/gmrt/eswitzer/GBT/simulations/15hr_optimalmap762_str/sim_beam_000.npy'
sim_multiplier = 1.
basemap = 'GBT_15hr_optimalmap_selfcal_762'
# Note that cleaning variants with simulations added etc get different paths
output_root = 'GBT_15hr_optimalmap_selfcal_762_cleaned'

#-----------------------------------------------------------------------------
# use the base map parameters above to make a few map cleaning cases
#-----------------------------------------------------------------------------
# clean_{map} (map)
if do_cleaning:
    pipe_modules.append((pair_set.PairSet, ('fs1_', 'fs_')))
fs1_map2 = basemap
fs1_map1 = basemap
fs1_noise_inv1 = basemap
fs1_noise_inv2 = basemap
fs1_output_root = output_root + "_path_Eric"
fs1_freq_list = freq_list
fs1_modes = mode_list
fs1_factorizable_noise = True
fs1_convolve = common_res_convolution
fs1_sub_weighted_mean = sub_weighted_mean

# clean_{map+sim} (map+sim)
if do_cleaning:
    pipe_modules.append((pair_set.PairSet, ('fs2_', 'fs_')))
fs2_map2 = basemap
fs2_map1 = basemap
fs2_noise_inv1 = basemap
fs2_noise_inv2 = basemap
fs2_output_root = output_root + "_plussim_path_Eric"
fs2_freq_list = freq_list
fs2_modes = mode_list
fs2_factorizable_noise = True
fs2_convolve = common_res_convolution
fs2_sub_weighted_mean = sub_weighted_mean
fs2_simfile = simfile
fs2_sim_multiplier = sim_multiplier
fs2_subtract_inputmap_from_sim = False
fs2_subtract_sim_from_inputmap = False

# clean_{map+sim} (sim)
if do_cleaning:
    pipe_modules.append((pair_set.PairSet, ('fs3_', 'fs_')))
fs3_map2 = basemap
fs3_map1 = basemap
fs3_noise_inv1 = basemap
fs3_noise_inv2 = basemap
fs3_output_root = output_root + "_plussim_minusmap_path_Eric"
fs3_freq_list = freq_list
fs3_modes = mode_list
fs3_factorizable_noise = True
fs3_convolve = common_res_convolution
fs3_sub_weighted_mean = sub_weighted_mean
fs3_simfile = simfile
fs3_sim_multiplier = sim_multiplier
fs3_subtract_inputmap_from_sim = True
fs3_subtract_sim_from_inputmap = False

# clean_{map+sim} (map)
if do_cleaning:
    pipe_modules.append((pair_set.PairSet, ('fs4_', 'fs_')))
fs4_map2 = basemap
fs4_map1 = basemap
fs4_noise_inv1 = basemap
fs4_noise_inv2 = basemap
fs4_output_root = output_root + "_plussim_minussim_path_Eric"
fs4_freq_list = freq_list
fs4_modes = mode_list
fs4_factorizable_noise = True
fs4_convolve = common_res_convolution
fs4_sub_weighted_mean = sub_weighted_mean
fs4_simfile = simfile
fs4_sim_multiplier = sim_multiplier
fs4_subtract_inputmap_from_sim = False
fs4_subtract_sim_from_inputmap = True

#-----------------------------------------------------------------------------
# now run the power spectra
#-----------------------------------------------------------------------------
if do_power:
    pipe_modules.append((pwrspec_combinations.PwrspecCombinations, ('xs1_', 'xs_')))
xs1_unitless = True
xs1_return_3d = False
xs1_truncate = False
xs1_window = None
xs1_refinement = 2
xs1_pad = 5
xs1_order = 2
xs1_bins = [0.00765314, 2.49977141, 35]
xs1_freq_list = freq_list
xs1_map_key = basemap + "_cleaned"
xs1_outfile = basemap + ".shelve"

if do_power:
    pipe_modules.append((pwrspec_combinations.PwrspecCombinations, ('xs2_', 'xs_')))
xs2_unitless = True
xs2_return_3d = False
xs2_truncate = False
xs2_window = None
xs2_refinement = 2
xs2_pad = 5
xs2_order = 2
xs2_bins = [0.00765314, 2.49977141, 35]
xs2_freq_list = freq_list
xs2_map_key = basemap + "_cleaned_plussim"
xs2_outfile = basemap + "_plussim.shelve"

if do_power:
    pipe_modules.append((pwrspec_combinations.PwrspecCombinations, ('xs3_', 'xs_')))
xs3_unitless = True
xs3_return_3d = False
xs3_truncate = False
xs3_window = None
xs3_refinement = 2
xs3_pad = 5
xs3_order = 2
xs3_bins = [0.00765314, 2.49977141, 35]
xs3_freq_list = freq_list
xs3_map_key = basemap + "_cleaned_plussim_minusmap"
xs3_outfile = basemap + "_plussim_minusmap.shelve"
